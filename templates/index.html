<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRAJEN SEO</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --black: #000000; --mg: #565656; --lg: #9e9e9e; --orange: #fba92c; --white: #ffffff;
            --bg: #050505; --s1: #0c0c0c; --s2: #111; --s3: #181818; --s4: #1e1e1e;
            --b1: #1a1a1a; --b2: #252525; --b3: #333;
            --og: rgba(251,169,44,.08); --og2: rgba(251,169,44,.15); --og3: rgba(251,169,44,.25);
            --w5: rgba(255,255,255,.05); --w8: rgba(255,255,255,.08); --w12: rgba(255,255,255,.12);
            --gn: #34d399; --gnd: rgba(52,211,153,.1); --rd: #f87171; --rdd: rgba(248,113,113,.1);
            --yl: #fbbf24; --yld: rgba(251,191,36,.1);
            --r: 12px; --rs: 8px; --rl: 16px;
        }
        *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--white);min-height:100vh;-webkit-font-smoothing:antialiased;overflow:hidden}
        ::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--b2);border-radius:3px}::-webkit-scrollbar-thumb:hover{background:var(--b3)}

        /* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
        .hd{display:flex;align-items:center;justify-content:space-between;padding:0 28px;height:52px;background:var(--black);border-bottom:1px solid var(--b1);backdrop-filter:blur(20px);position:relative;z-index:99}
        .hd::after{content:'';position:absolute;bottom:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--orange),transparent);opacity:.15}
        .hd-l{display:flex;align-items:center;gap:12px}
        .hd-l h1{font-size:15px;font-weight:700;letter-spacing:-.4px}
        .hd-l h1 b{color:var(--orange);font-weight:800}
        .hd-badge{font-size:9px;color:var(--orange);background:var(--og);padding:3px 10px;border-radius:99px;font-weight:600;letter-spacing:.8px;border:1px solid rgba(251,169,44,.15)}
        .hd-r{display:flex;align-items:center;gap:14px;font-size:12px;color:var(--lg)}
        .hd-r a{color:var(--lg);text-decoration:none;transition:color .15s}
        .hd-r a:hover{color:var(--orange)}

        /* ‚ïê‚ïê‚ïê LAYOUT ‚ïê‚ïê‚ïê */
        .layout{display:grid;grid-template-columns:360px 1fr;height:calc(100vh - 52px)}
        @media(max-width:960px){.layout{grid-template-columns:1fr}}

        /* ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê */
        .sidebar{padding:24px 20px;border-right:1px solid var(--b1);overflow-y:auto;background:var(--s1)}
        .lbl{font-size:10px;font-weight:600;color:var(--lg);text-transform:uppercase;letter-spacing:1.5px;margin:20px 0 8px}
        .lbl:first-child{margin-top:0}
        input[type="text"],textarea{
            width:100%;padding:10px 14px;background:var(--s2);border:1px solid var(--b1);
            border-radius:var(--rs);color:var(--white);font-size:13px;font-family:inherit;
            outline:none;transition:all .2s
        }
        input::placeholder,textarea::placeholder{color:var(--mg)}
        input:focus,textarea:focus{border-color:rgba(251,169,44,.4);box-shadow:0 0 0 3px var(--og)}
        textarea{resize:vertical;min-height:72px;line-height:1.5}
        .hint{font-size:10px;color:var(--mg);margin-top:5px;line-height:1.5}
        .modes{display:flex;gap:6px;margin-bottom:12px}
        .mbtn{
            flex:1;padding:12px 8px;background:var(--s2);border:1px solid var(--b1);
            border-radius:var(--rs);color:var(--mg);cursor:pointer;text-align:center;
            transition:all .2s;font-family:inherit
        }
        .mbtn.on{border-color:var(--orange);color:var(--orange);background:var(--og)}
        .mbtn:hover:not(.on){border-color:var(--b3);background:var(--s3)}
        .mbtn strong{display:block;font-size:13px;font-weight:600;margin-bottom:2px}
        .mbtn small{font-size:10px;color:var(--mg)}
        .btn-go{
            width:100%;padding:12px;margin-top:20px;
            background:var(--orange);color:var(--black);border:none;border-radius:var(--rs);
            font-size:13px;font-weight:700;font-family:inherit;cursor:pointer;
            letter-spacing:-.2px;transition:all .2s;position:relative;overflow:hidden
        }
        .btn-go:hover{filter:brightness(1.08);transform:translateY(-1px);box-shadow:0 8px 24px rgba(251,169,44,.2)}
        .btn-go:disabled{opacity:.35;cursor:not-allowed;transform:none;box-shadow:none;filter:none}
        .btn-go::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.15),transparent);transform:translateX(-100%);transition:transform .5s}
        .btn-go:hover::after{transform:translateX(100%)}
        .btn-stop{
            width:100%;padding:12px;margin-top:6px;
            background:var(--rdd);color:var(--rd);border:1px solid rgba(248,113,113,.15);
            border-radius:var(--rs);font-size:13px;font-weight:600;font-family:inherit;
            cursor:pointer;transition:all .15s;display:none
        }
        .btn-stop:hover{background:rgba(248,113,113,.18)}
        .tbtn{background:none;border:none;color:var(--mg);font-size:10px;cursor:pointer;font-family:inherit;letter-spacing:.5px;text-transform:uppercase}
        .tbtn:hover{color:var(--orange)}

        /* ‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê */
        .main{padding:24px 28px;overflow-y:auto;background:var(--bg)}

        .welcome{text-align:center;padding:80px 20px}
        .w-icon{
            width:56px;height:56px;border-radius:14px;
            background:linear-gradient(135deg,var(--og2),var(--og));
            display:inline-flex;align-items:center;justify-content:center;
            font-size:24px;margin-bottom:18px;border:1px solid rgba(251,169,44,.12)
        }
        .welcome h2{font-size:18px;font-weight:700;margin-bottom:6px;letter-spacing:-.4px}
        .welcome p{color:var(--mg);font-size:13px;line-height:1.6}

        /* ‚ïê‚ïê‚ïê STEPS ‚ïê‚ïê‚ïê */
        .steps{margin-bottom:24px}
        .stp{display:flex;align-items:center;gap:12px;padding:9px 0}
        .stp+.stp{border-top:1px solid var(--w5)}
        .stp-i{
            width:28px;height:28px;border-radius:var(--rs);display:flex;align-items:center;
            justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;transition:all .3s
        }
        .stp-i.pending{background:var(--s3);color:var(--mg)}
        .stp-i.running{background:var(--og);color:var(--orange);animation:blink 1.8s ease-in-out infinite}
        .stp-i.done{background:var(--gnd);color:var(--gn)}
        .stp-i.warning{background:var(--yld);color:var(--yl)}
        .stp-i.error{background:var(--rdd);color:var(--rd)}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:.5}}
        .stp-n{font-size:12px;font-weight:500;color:var(--white);flex:1}
        .stp-d{font-size:10px;color:var(--mg);margin-top:1px}

        /* ‚ïê‚ïê‚ïê CARDS ‚ïê‚ïê‚ïê */
        .crd{background:var(--s1);border:1px solid var(--b1);border-radius:var(--rl);padding:18px;margin:12px 0;position:relative;overflow:hidden}
        .crd::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--b2),transparent)}
        .crd-t{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--lg);margin-bottom:14px}
        .crd-t b{color:var(--orange)}

        .sg{display:grid;gap:8px;margin-top:12px}
        .sg3{grid-template-columns:repeat(3,1fr)}.sg4{grid-template-columns:repeat(4,1fr)}
        .sc{text-align:center;padding:12px 6px;background:var(--s2);border-radius:var(--r);border:1px solid var(--b1)}
        .sv{font-size:20px;font-weight:800;color:var(--white);letter-spacing:-.8px}.sv.xl{font-size:40px}
        .sv span{font-size:14px;color:var(--mg);font-weight:400}
        .sl{font-size:9px;color:var(--mg);margin-top:3px;text-transform:uppercase;letter-spacing:.5px}

        /* ‚ïê‚ïê‚ïê PROGRESS ‚ïê‚ïê‚ïê */
        .pg-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
        .pg-lbl{font-size:12px;font-weight:500;color:var(--white)}
        .pg-ct{font-size:12px;font-weight:700;color:var(--orange);font-family:'JetBrains Mono',monospace}
        .pg-bar{width:100%;height:3px;background:var(--s3);border-radius:2px;overflow:hidden}
        .pg-fill{height:100%;background:linear-gradient(90deg,var(--orange),#fcd34d);border-radius:2px;transition:width .5s ease;box-shadow:0 0 8px rgba(251,169,44,.3)}
        .chips{display:flex;flex-wrap:wrap;gap:5px;margin-top:12px}
        .bchip{padding:4px 12px;border-radius:99px;font-size:10px;font-weight:600;font-family:'JetBrains Mono',monospace;letter-spacing:.3px}
        .bchip.pend{background:var(--s3);color:var(--mg);border:1px solid var(--b1)}
        .bchip.ok{background:var(--gnd);color:var(--gn);border:1px solid rgba(52,211,153,.2)}
        .bchip.bad{background:var(--rdd);color:var(--rd);border:1px solid rgba(248,113,113,.2)}

        /* ‚ïê‚ïê‚ïê COLLAPSIBLE ‚ïê‚ïê‚ïê */
        .pnl{background:var(--s1);border:1px solid var(--b1);border-radius:var(--rl);margin:12px 0;overflow:hidden}
        .pnl-h{padding:13px 18px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-weight:600;font-size:12px;color:var(--white);transition:background .12s;user-select:none}
        .pnl-h:hover{background:var(--w5)}
        .pnl-h .arr{color:var(--mg);transition:transform .25s;font-size:10px}
        .pnl-h.open .arr{transform:rotate(180deg)}
        .pnl-b{display:none;padding:0 18px 16px;font-size:11px;color:rgba(255,255,255,.7);line-height:1.65;max-height:700px;overflow-y:auto}
        .pnl-b.open{display:block}
        .sec{margin:10px 0;padding:10px 0;border-top:1px solid var(--w5)}.sec:first-child{border-top:none}
        .sec-t{font-weight:700;font-size:10px;color:var(--orange);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px}
        .tag{display:inline-flex;align-items:center;padding:3px 10px;border-radius:99px;font-size:10px;margin:2px;font-weight:500;gap:4px}
        .tag.g{background:var(--gnd);color:var(--gn)}.tag.r{background:var(--rdd);color:var(--rd)}
        .tag.w{background:var(--yld);color:var(--yl)}.tag.o{background:var(--og);color:var(--orange)}
        .tag.d{background:var(--w5);color:var(--lg)}.tag.p{background:rgba(139,92,246,.1);color:#a78bfa}
        .tag.c{background:rgba(6,182,212,.1);color:#22d3ee}.tag.pk{background:rgba(236,72,153,.1);color:#f472b6}
        .chip{display:inline-block;padding:3px 8px;margin:2px;background:var(--s3);border:1px solid var(--b1);border-radius:4px;font-size:10px;color:rgba(255,255,255,.7);font-family:'JetBrains Mono',monospace}
        .chip.must{border-color:var(--rd);color:var(--rd);background:var(--rdd)}
        .chip.ext{border-color:var(--orange);color:var(--orange);background:var(--og)}
        .chip.stop{border-color:var(--b2);color:var(--mg);text-decoration:line-through}

        .bd{background:var(--s2);border:1px solid var(--b1);border-radius:var(--r);padding:12px;margin:6px 0}
        .bd-h{display:flex;justify-content:space-between;align-items:center;cursor:pointer;font-size:11px;font-weight:600}
        .bd-b{display:none;margin-top:10px;font-size:11px}.bd-b.open{display:block}
        .flags{display:flex;gap:3px;flex-wrap:wrap;margin:8px 0}
        .sub{margin:8px 0;padding:8px 0;border-top:1px dashed var(--w5)}.sub:first-child{border-top:none}
        .sub-t{font-weight:700;font-size:9px;color:var(--lg);text-transform:uppercase;letter-spacing:.8px;margin-bottom:5px}
        .pre{background:var(--black);border:1px solid var(--b1);border-radius:var(--rs);padding:10px;font-size:10px;color:var(--lg);max-height:100px;overflow-y:auto;white-space:pre-wrap;word-break:break-word;margin-top:5px;font-family:'JetBrains Mono',monospace;line-height:1.5}

        /* ‚ïê‚ïê‚ïê COMPLIANCE ‚ïê‚ïê‚ïê */
        .cr{display:flex;align-items:center;gap:8px;padding:3px 0;font-size:11px}
        .cr .i{width:16px;text-align:center;flex-shrink:0;font-size:11px}
        .cr.ok .i{color:var(--gn)}.cr.no .i{color:var(--rd)}.cr.half .i{color:var(--yl)}
        .cr .l{flex:1;color:rgba(255,255,255,.7)}.cr .p{font-size:10px;color:var(--mg);width:36px;text-align:right;font-family:'JetBrains Mono',monospace}
        .cg{display:grid;grid-template-columns:repeat(auto-fill,minmax(105px,1fr));gap:6px;margin:12px 0}
        .cs{text-align:center;padding:10px 4px;background:var(--s2);border-radius:var(--r);border:1px solid var(--b1)}
        .cs .v{font-size:16px;font-weight:800;letter-spacing:-.5px}.cs .lb{font-size:8px;color:var(--mg);margin-top:3px;text-transform:uppercase;letter-spacing:.5px}

        /* ‚ïê‚ïê‚ïê S1 PANEL ‚ïê‚ïê‚ïê */
        .s1-sec{margin:0;padding:0;border-top:1px solid var(--w8)}
        .s1-sec:first-child{border-top:none}
        .s1-hdr{display:flex;align-items:center;gap:10px;padding:12px 0;cursor:pointer;user-select:none}
        .s1-hdr:hover{opacity:.85}
        .s1-num{width:24px;height:24px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;flex-shrink:0;background:var(--og);color:var(--orange)}
        .s1-ttl{flex:1;font-size:11px;font-weight:700;color:var(--white);letter-spacing:-.1px}
        .s1-ttl small{font-weight:400;color:var(--mg);margin-left:6px}
        .s1-arr{color:var(--mg);font-size:9px;transition:transform .2s}
        .s1-sec.open .s1-arr{transform:rotate(180deg)}
        .s1-body{display:none;padding:0 0 14px 34px;font-size:11px;color:rgba(255,255,255,.7)}
        .s1-sec.open .s1-body{display:block}
        .s1-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:6px;margin:8px 0}
        .s1-stat{text-align:center;padding:10px 6px;background:var(--s2);border-radius:var(--rs);border:1px solid var(--b1)}
        .s1-stat .v{font-size:18px;font-weight:800;color:var(--orange);letter-spacing:-.5px}
        .s1-stat .l{font-size:8px;color:var(--mg);margin-top:2px;text-transform:uppercase;letter-spacing:.5px}
        .s1-row{display:flex;align-items:center;gap:8px;padding:4px 0;font-size:11px;color:var(--lg)}
        .s1-row .dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
        .s1-row .dot.on{background:var(--gn)}.s1-row .dot.off{background:var(--b3)}.s1-row .dot.warn{background:var(--yl)}
        .s1-bar-row{display:flex;align-items:flex-end;gap:3px;height:50px;margin:8px 0}
        .s1-bar-col{text-align:center;flex:1}
        .s1-bar-col .bar{background:var(--orange);border-radius:3px 3px 0 0;opacity:.7;min-height:4px}
        .s1-bar-col .lbl{font-size:8px;color:var(--mg);margin-top:2px}
        .s1-cause{display:flex;align-items:center;gap:6px;padding:4px 0;font-size:11px}
        .s1-cause .from{color:var(--lg)}.s1-cause .arrow{color:var(--orange);font-weight:700}.s1-cause .to{color:var(--lg)}
        .s1-ent{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;margin:2px;border-radius:99px;font-size:10px;font-weight:500}
        .s1-ent.must{background:var(--rdd);color:var(--rd);border:1px solid rgba(248,113,113,.15)}
        .s1-ent.top{background:var(--og);color:var(--orange)}
        .s1-ent.rel{background:rgba(139,92,246,.1);color:#a78bfa}
        .s1-ymyl{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;margin:3px;border-radius:var(--rs);font-size:11px;font-weight:500;background:var(--s2);border:1px solid var(--b1)}
        .s1-ymyl.active{border-color:var(--rd);background:var(--rdd);color:var(--rd)}
        .s1-instr{background:var(--black);border:1px solid var(--b1);border-radius:var(--rs);padding:12px;font-size:10px;color:var(--lg);white-space:pre-wrap;word-break:break-word;margin:6px 0;font-family:'JetBrains Mono',monospace;line-height:1.5;max-height:180px;overflow-y:auto}

        /* ‚ïê‚ïê‚ïê ARTICLE ‚ïê‚ïê‚ïê */
        .art{background:var(--s1);border:1px solid var(--b1);border-radius:var(--rl);padding:24px;margin:14px 0;max-height:480px;overflow-y:auto;line-height:1.8;font-size:14px}
        .art h2{color:var(--orange);font-size:17px;margin:22px 0 8px;font-weight:700;letter-spacing:-.3px}.art h2:first-child{margin-top:0}
        .art h3{color:var(--white);font-size:14px;margin:16px 0 6px;font-weight:600}
        .art p{color:rgba(255,255,255,.65);margin-bottom:12px}

        .exp{display:flex;gap:8px;margin-top:14px}
        .btn-e{flex:1;padding:11px;border-radius:var(--rs);border:1px solid var(--b1);background:var(--s1);color:var(--white);font-size:12px;font-weight:600;cursor:pointer;text-align:center;text-decoration:none;transition:all .15s;font-family:inherit}
        .btn-e:hover{border-color:var(--orange);color:var(--orange)}
        .btn-e.pri{background:var(--orange);border-color:var(--orange);color:var(--black)}
        .btn-e.pri:hover{filter:brightness(1.1)}

        .done{background:linear-gradient(135deg,var(--og2),var(--og));border:1px solid rgba(251,169,44,.15);border-radius:var(--rl);padding:22px;text-align:center;margin:14px 0}
        .done h2{color:var(--orange);font-size:17px;font-weight:800;margin-bottom:3px;letter-spacing:-.3px}
        .done p{color:rgba(255,255,255,.6);font-size:12px}

        .logbox{background:var(--black);border:1px solid var(--b1);border-radius:var(--r);padding:12px 14px;max-height:220px;overflow-y:auto;font-family:'JetBrains Mono',monospace;font-size:10px;line-height:1.7}
        .log-line{color:var(--lg)}.log-line .ts{color:var(--mg)}
    </style>
</head>
<body>
<div class="hd">
    <div class="hd-l"><h1>BRAJEN <b>SEO</b></h1><span class="hd-badge">V45.2</span></div>
    <div class="hd-r"><span>{{ username }}</span><a href="/logout">Wyloguj</a></div>
</div>
<div class="layout">
    <div class="sidebar">
        <div class="lbl">Keyword</div>
        <input type="text" id="mainKeyword" placeholder="np. od czego zaczƒÖƒá przeprowadzkƒô">
        <div class="lbl">Tryb</div>
        <div class="modes">
            <div class="mbtn on" data-mode="standard" onclick="selMode('standard')"><strong>Standard</strong><small>6‚Äì9 batchy</small></div>
            <div class="mbtn" data-mode="fast" onclick="selMode('fast')"><strong>Fast</strong><small>3 batche</small></div>
        </div>
        <div class="lbl">Nag≈Ç√≥wki H2 <span style="opacity:.4;font-weight:400">opcjonalne</span></div>
        <textarea id="h2Structure" rows="4" placeholder="Puste = auto z S1&#10;Lub wpisz wskaz√≥wki"></textarea>
        <div class="hint">Puste ‚Üí system sam wygeneruje z analizy konkurencji.</div>
        <div class="lbl">Frazy BASIC <button class="tbtn" onclick="tog('bsc')">poka≈º</button></div>
        <div id="bsc" style="display:none"><textarea id="basicTerms" rows="3" placeholder="fraza: min-maxx"></textarea></div>
        <div class="lbl">Frazy EXTENDED <button class="tbtn" onclick="tog('ext')">poka≈º</button></div>
        <div id="ext" style="display:none"><textarea id="extendedTerms" rows="3" placeholder="fraza: min-maxx"></textarea></div>
        <button class="btn-go" id="btnStart" onclick="startWorkflow()">Uruchom workflow ‚Üí</button>
        <button class="btn-stop" id="btnStop" onclick="stopWF()">Zatrzymaj</button>
    </div>
    <div class="main">
        <div id="wel" class="welcome"><div class="w-icon">‚ö°</div><h2>BRAJEN SEO Engine</h2><p>Wpisz keyword i uruchom workflow</p></div>
        <div id="prog" style="display:none">
            <div class="steps" id="stC"></div>
            <div class="crd" id="h2C" style="display:none"><div class="crd-t"><b>Plan</b> H2</div><div id="h2L"></div></div>
            <div class="pnl" id="s1P" style="display:none"><div class="pnl-h" onclick="tPnl('s1P')"><span>üìä Analiza S1 ‚Äî Pe≈Çna mapa tematu</span><span class="arr">‚ñº</span></div><div class="pnl-b" id="s1B" style="max-height:900px"></div></div>
            <div class="pnl" id="biP" style="display:none"><div class="pnl-h" onclick="tPnl('biP')"><span>üéØ Pre-batch info</span><span class="arr">‚ñº</span></div><div class="pnl-b" id="biB"></div></div>
            <div class="crd" id="bpC" style="display:none"><div class="pg-top"><span class="pg-lbl">Generowanie</span><span class="pg-ct" id="bCt">0/0</span></div><div class="pg-bar"><div class="pg-fill" id="bFill" style="width:0%"></div></div><div class="chips" id="bRes"></div></div>
            <div class="crd" id="frC" style="display:none"><div class="crd-t"><b>Final</b> Review</div><div class="sg sg4"><div class="sc"><div class="sv" id="frS">‚Äî</div><div class="sl">Score</div></div><div class="sc"><div class="sv" id="frSt">‚Äî</div><div class="sl">Status</div></div><div class="sc"><div class="sv" id="frM">‚Äî</div><div class="sl">BrakujƒÖce</div></div><div class="sc"><div class="sv" id="frI">‚Äî</div><div class="sl">Issues</div></div></div><div id="frD" style="font-size:11px;color:var(--mg);margin-top:10px;max-height:60px;overflow-y:auto"></div></div>
            <div class="crd" id="edC" style="display:none"><div class="crd-t"><b>Editorial</b> Review</div><div class="sv xl" style="text-align:center" id="edSc">‚Äî<span>/10</span></div><div class="sg sg3"><div class="sc"><div class="sv" id="edCh">‚Äî</div><div class="sl">Zmiany</div></div><div class="sc"><div class="sv" id="edW">‚Äî</div><div class="sl">S≈Çowa</div></div><div class="sc"><div class="sv" id="edR">‚Äî</div><div class="sl">Rollback</div></div></div></div>
            <div class="pnl" id="cpP" style="display:none"><div class="pnl-h" onclick="tPnl('cpP')"><span>‚úÖ S1 Compliance</span><span class="arr">‚ñº</span></div><div class="pnl-b" id="cpB"></div></div>
            <div class="done" id="doneB" style="display:none"><h2>‚úì Artyku≈Ç gotowy</h2><p id="doneD"></p></div>
            <div class="exp" id="expB" style="display:none"><a class="btn-e pri" id="exH">HTML</a><a class="btn-e" id="exD">DOCX</a></div>
            <div style="margin-top:20px"><span class="lbl">PodglƒÖd <button class="tbtn" onclick="tog('artP')">poka≈º</button></span></div>
            <div class="art" id="artP" style="display:none"></div>
            <div style="margin-top:16px"><span class="lbl">Logi <button class="tbtn" onclick="tog('logC')">poka≈º</button></span></div>
            <div class="logbox" id="logC"></div>
        </div>
    </div>
</div>
<script>
(function(){const n=['S1 Analysis','YMYL','H2 Plan','Create Project','Phrase Hierarchy','Batch Loop','PAA / FAQ','Final Review','Editorial','Export'],c=document.getElementById('stC');n.forEach((x,i)=>{c.innerHTML+=`<div class="stp"><div class="stp-i pending" id="si${i+1}">${i+1}</div><div><div class="stp-n">${x}</div><div class="stp-d" id="sd${i+1}">‚Äî</div></div></div>`;})})();

let mode='standard',jid=null,tb=0,es=null;
const O='#fba92c',G='#34d399',R='#f87171',W='#fbbf24',M='#9e9e9e';

// XSS sanitization for SSE data
function esc(s){if(!s)return'';const d=document.createElement('div');d.textContent=s;return d.innerHTML}

function selMode(m){mode=m;document.querySelectorAll('.mbtn').forEach(b=>b.classList.toggle('on',b.dataset.mode===m))}
function tog(id){const e=document.getElementById(id);e.style.display=e.style.display==='none'?'':'none'}
function log(m){const c=document.getElementById('logC');c.innerHTML+=`<div class="log-line"><span class="ts">${new Date().toLocaleTimeString('pl-PL')}</span> ${esc(m)}</div>`;c.scrollTop=c.scrollHeight}
function uStep(s,st,d){const i=document.getElementById(`si${s}`),dt=document.getElementById(`sd${s}`);if(!i)return;i.className=`stp-i ${st}`;if(st==='done')i.textContent='‚úì';else if(st==='running')i.textContent='‚ü≥';else if(st==='warning')i.textContent='!';else if(st==='error')i.textContent='‚úó';if(d&&dt)dt.textContent=d}
function tPnl(id){const p=document.getElementById(id),b=p.querySelector('.pnl-b'),h=p.querySelector('.pnl-h');b.classList.toggle('open');h.classList.toggle('open')}
function tBd(id){document.getElementById(id).classList.toggle('open')}

function kc(l,c){if(!l||!l.length)return'<span style="color:var(--mg)">‚Äî</span>';return l.map(k=>`<span class="chip ${c}">${esc(typeof k==='object'?(k.keyword||JSON.stringify(k)):k)}</span>`).join('')}
function fl(l,a,c){return`<span class="tag ${a?c:'d'}">${a?'‚úÖ':'‚Äî'} ${esc(l)}</span>`}
function ss(v){if(v==null)return'';if(typeof v==='string')return esc(v);return typeof v==='object'?esc(JSON.stringify(v)):esc(String(v))}
function el(i){if(typeof i==='string')return esc(i);return esc(i.text||i.entity||i.name||i.phrase||i.ngram||i.question||i.pattern||i.h2||i.title||i.topic||i.gap||i.keyword||(typeof i==='object'?Object.values(i).find(v=>typeof v==='string'&&v.length>1&&v.length<100)||JSON.stringify(i):String(i)))}
function fc(f){const p=f.split('/');if(p.length!==2)return M;const[n,d]=p.map(Number);if(!d)return M;const r=(n/d)*100;return r>=70?G:r>=40?W:R}

// ‚ïê‚ïê‚ïê S1 PANEL (10 Sections) ‚ïê‚ïê‚ïê
function tS1(id){const s=document.getElementById(id);s.classList.toggle('open')}
function s1Sec(n,title,badge,body){return`<div class="s1-sec" id="s1s${n}"><div class="s1-hdr" onclick="tS1('s1s${n}')"><div class="s1-num">${n}</div><div class="s1-ttl">${title}${badge?` <small>${badge}</small>`:''}</div><span class="s1-arr">‚ñº</span></div><div class="s1-body">${body}</div></div>`}

function rS1(d){
    document.getElementById('s1P').style.display='';
    let h='';

    // ‚îÄ‚îÄ‚îÄ 1Ô∏è‚É£ SERP & Competitor Structure ‚îÄ‚îÄ‚îÄ
    let b1='';
    b1+=`<div class="s1-grid">`;
    b1+=`<div class="s1-stat"><div class="v">${d.recommended_length||'?'}</div><div class="l">Rekomendacja</div></div>`;
    b1+=`<div class="s1-stat"><div class="v">${d.median_length||'?'}</div><div class="l">Mediana</div></div>`;
    b1+=`<div class="s1-stat"><div class="v">${d.average_length||'?'}</div><div class="l">≈örednia</div></div>`;
    b1+=`<div class="s1-stat"><div class="v">${d.analyzed_urls||'?'}</div><div class="l">Stron</div></div>`;
    b1+=`<div class="s1-stat"><div class="v">${d.h2_patterns_count||0}</div><div class="l">Wzorc√≥w H2</div></div>`;
    b1+=`</div>`;
    if(d.search_intent)b1+=`<div style="margin:8px 0"><span class="tag o" style="font-size:11px">üéØ ${esc(d.search_intent)}</span></div>`;
    const wc=d.word_counts||[];
    if(wc.length){const mx=Math.max(...wc.slice(0,10));b1+=`<div style="margin:10px 0"><div style="font-size:9px;color:var(--mg);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px">Rozk≈Çad d≈Çugo≈õci top ${wc.length}</div><div class="s1-bar-row">${wc.slice(0,10).map(w=>{const ht=mx>0?Math.round((w/mx)*44)+4:10;return`<div class="s1-bar-col"><div class="bar" style="height:${ht}px"></div><div class="lbl">${w}</div></div>`}).join('')}</div></div>`}
    const h2p=d.competitor_h2_patterns||[];
    if(h2p.length)b1+=`<div style="margin:10px 0"><div style="font-size:9px;color:var(--mg);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px">DominujƒÖce wzorce H2</div>${h2p.slice(0,12).map((x,i)=>`<div style="color:var(--lg);font-size:11px;padding:2px 0"><span style="color:var(--orange);font-weight:700;width:18px;display:inline-block">${i+1}.</span>${el(x)}</div>`).join('')}</div>`;
    const ss2=d.serp_sources||[];
    if(ss2.length)b1+=`<div style="margin:10px 0"><div style="font-size:9px;color:var(--mg);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px">≈πr√≥d≈Ça SERP</div>${ss2.slice(0,8).map(s=>`<div style="font-size:10px;color:var(--mg);padding:2px 0">${esc(typeof s==='string'?s:(s.url||s.title||s.domain||JSON.stringify(s)).substring(0,80))}</div>`).join('')}</div>`;
    const fs=d.featured_snippet,aio=d.ai_overview,rs=d.related_searches||[];
    if(fs)b1+=`<div style="margin:6px 0"><span class="tag g" style="white-space:normal;line-height:1.4">üìã Featured Snippet: ${esc((typeof fs==='string'?fs:(fs.text||JSON.stringify(fs))).substring(0,150))}</span></div>`;
    if(aio)b1+=`<div style="margin:6px 0"><span class="tag o" style="white-space:normal;line-height:1.4">ü§ñ AI Overview: ${esc((typeof aio==='string'?aio:(aio.text||JSON.stringify(aio))).substring(0,150))}</span></div>`;
    if(rs.length)b1+=`<div style="margin:6px 0"><div style="font-size:9px;color:var(--mg);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px">Related Searches</div>${rs.map(r=>`<span class="tag d">${ss(r)}</span>`).join('')}</div>`;
    h+=s1Sec(1,'Analiza SERP i struktury konkurencji',`${d.analyzed_urls||'?'} stron`,b1);

    // ‚îÄ‚îÄ‚îÄ 2Ô∏è‚É£ Causal Triplets ‚îÄ‚îÄ‚îÄ
    let b2='';
    const cc=d.causal_chains||[],csi=d.causal_singles||[];
    const totalC=(d.causal_count_chains||0)+(d.causal_count_singles||0);
    if(cc.length){b2+=`<div style="font-size:9px;color:var(--mg);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px">≈Åa≈Ñcuchy (A ‚Üí B ‚Üí C)</div>`;cc.slice(0,8).forEach(t=>{b2+=`<div class="s1-cause"><span class="from">${esc(t.cause||t.from||'?')}</span><span class="arrow">‚Üí</span><span class="to">${esc(t.effect||t.to||'?')}</span></div>`})}
    if(csi.length){b2+=`<div style="font-size:9px;color:var(--mg);margin:8px 0 6px;text-transform:uppercase;letter-spacing:.5px">Relacje kauzalne</div>`;csi.slice(0,8).forEach(t=>{b2+=`<div class="s1-cause"><span class="from">${esc(t.cause||t.from||'?')}</span><span class="arrow">‚Üí</span><span class="to">${esc(t.effect||t.to||'?')}</span></div>`})}
    if(d.causal_instruction)b2+=`<div style="margin-top:8px"><div style="font-size:9px;color:var(--mg);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px">Instrukcja</div><div class="s1-instr">${esc(d.causal_instruction)}</div></div>`;
    if(!totalC)b2+=`<div style="color:var(--mg);font-style:italic">Brak danych kauzalnych z konkurencji</div>`;
    h+=s1Sec(2,'Causal Triplets ‚Äî mapa przyczynowo-skutkowa',`${totalC} relacji`,b2);

    // ‚îÄ‚îÄ‚îÄ 3Ô∏è‚É£ Gap Analysis ‚îÄ‚îÄ‚îÄ
    let b3='';
    const pU=d.paa_unanswered||[],sM=d.subtopic_missing||[],dM=d.depth_missing||[],sh2=d.suggested_h2s||[];
    const totalGaps=pU.length+sM.length+dM.length;
    if(pU.length){b3+=`<div style="margin:6px 0"><div style="font-size:9px;margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px"><span style="color:var(--rd)">üî¥</span> PAA Unanswered (${pU.length})</div>${pU.map(g=>`<span class="tag r">${el(g)}</span>`).join('')}</div>`}
    if(sM.length){b3+=`<div style="margin:6px 0"><div style="font-size:9px;margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px"><span style="color:var(--orange)">üü†</span> Subtopic Missing (${sM.length})</div>${sM.map(g=>`<span class="tag o">${el(g)}</span>`).join('')}</div>`}
    if(dM.length){b3+=`<div style="margin:6px 0"><div style="font-size:9px;margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px"><span style="color:var(--yl)">üü°</span> Depth Missing (${dM.length})</div>${dM.map(g=>`<span class="tag w">${el(g)}</span>`).join('')}</div>`}
    if(sh2.length){b3+=`<div style="margin:8px 0"><div style="font-size:9px;color:var(--gn);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px">‚ú® Sugerowane nowe H2</div>${sh2.map(x=>`<span class="tag g">${ss(x)}</span>`).join('')}</div>`}
    if(d.gaps_instruction)b3+=`<div style="margin-top:8px"><div style="font-size:9px;color:var(--mg);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px">Instrukcja priorytet√≥w</div><div class="s1-instr">${esc(d.gaps_instruction)}</div></div>`;
    if(!totalGaps&&!sh2.length)b3+=`<div style="color:var(--mg);font-style:italic">Brak wykrytych luk (mo≈ºliwe przy CSS-heavy stronach)</div>`;
    h+=s1Sec(3,'Gap Analysis ‚Äî przewagi konkurencyjne',`${totalGaps} luk`,b3);

    // ‚îÄ‚îÄ‚îÄ 4Ô∏è‚É£ Entity SEO ‚îÄ‚îÄ‚îÄ
    let b4='';
    const ent=d.entity_seo||{},tE=ent.top_entities||[],mE=ent.must_mention||[],eR=ent.relations||[],tC=ent.topical_coverage||[];
    if(mE.length)b4+=`<div style="margin:6px 0"><div style="font-size:9px;color:var(--rd);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px;font-weight:700">MUST MENTION</div>${mE.map(e=>`<span class="s1-ent must">${el(e)}</span>`).join('')}</div>`;
    if(tE.length)b4+=`<div style="margin:6px 0"><div style="font-size:9px;color:var(--mg);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px">Top encje (${ent.entity_count||tE.length})</div>${tE.slice(0,15).map(e=>{const name=el(e),typ=typeof e==='object'?(e.type||''):'',imp=typeof e==='object'?(e.importance||''):'';return`<span class="s1-ent top">${name}${typ?` <span style="font-size:8px;opacity:.5">${typ}</span>`:''}${imp?` <span style="font-size:8px;opacity:.5">${typeof imp==='number'?imp.toFixed(2):imp}</span>`:''}</span>`}).join('')}</div>`;
    if(eR.length)b4+=`<div style="margin:6px 0"><div style="font-size:9px;color:var(--mg);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px">Relacje miƒôdzy encjami</div>${eR.map(r=>{if(typeof r==='string')return`<span class="s1-ent rel">${esc(r)}</span>`;return`<span class="s1-ent rel">${esc(r.from||r.subject||'?')} ‚Üí ${esc(r.to||r.object||'?')}${r.relation?` (${esc(r.relation)})`:''}</span>`}).join('')}</div>`;
    if(tC.length)b4+=`<div style="margin:6px 0"><div style="font-size:9px;color:var(--mg);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px">Topical Coverage</div>${tC.slice(0,10).map(t=>{const topic=typeof t==='string'?t:(t.subtopic||t.topic||el(t)),pri=typeof t==='object'?(t.priority||''):'';return`<span class="tag ${pri==='MUST'?'r':pri==='HIGH'?'o':'d'}">${topic}${pri?` ¬∑ ${pri}`:''}</span>`}).join('')}</div>`;
    if(!tE.length&&!mE.length)b4+=`<div style="color:var(--mg);font-style:italic">Brak danych encji (CSS contamination?)</div>`;
    h+=s1Sec(4,'Encje ‚Äî mapa byt√≥w tematu',`${ent.entity_count||tE.length} encji`,b4);

    // ‚îÄ‚îÄ‚îÄ 5Ô∏è‚É£ N-grams & Collocations ‚îÄ‚îÄ‚îÄ
    let b5='';
    const ng=d.ngrams||[],skp=d.semantic_keyphrases||[];
    if(ng.length)b5+=`<div style="margin:6px 0"><div style="font-size:9px;color:var(--mg);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px">N-gramy (${ng.length})</div>${ng.map(n=>{const l=el(n),w=typeof n==='object'?(n.weight||n.score||''):'';return`<span class="tag c">${l}${w?` <span style="opacity:.5">¬∑ ${typeof w==='number'?w.toFixed(2):w}</span>`:''}</span>`}).join('')}</div>`;
    if(skp.length)b5+=`<div style="margin:6px 0"><div style="font-size:9px;color:var(--mg);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px">Semantic Keyphrases (${skp.length})</div>${skp.map(k=>`<span class="tag pk">${el(k)}</span>`).join('')}</div>`;
    if(!ng.length&&!skp.length)b5+=`<div style="color:var(--mg);font-style:italic">Brak danych n-gram√≥w</div>`;
    h+=s1Sec(5,'N-gramy i kolokacje',`${ng.length+skp.length} fraz`,b5);

    // ‚îÄ‚îÄ‚îÄ 6Ô∏è‚É£ Phrase Hierarchy ‚îÄ‚îÄ‚îÄ
    let b6='';
    const ph=d.phrase_hierarchy_preview||{};
    const phKeys=Object.keys(ph);
    if(phKeys.length){phKeys.forEach(strategy=>{const data=ph[strategy];b6+=`<div style="margin:6px 0"><span class="tag ${strategy==='extensions_sufficient'?'g':strategy==='need_standalone'?'r':'o'}" style="font-size:11px;font-weight:600">${strategy}</span>`;if(data&&data.description)b6+=`<div style="color:var(--lg);font-size:10px;margin:4px 0">${data.description}</div>`;if(data&&data.roots&&data.roots.length)b6+=`<div style="margin-top:4px">${data.roots.map(r=>`<span class="tag d">${typeof r==='string'?r:(r.root||el(r))} ${typeof r==='object'&&r.extensions?`<span style="opacity:.5">(${r.extensions} ext)</span>`:''}</span>`).join('')}</div>`;b6+=`</div>`})}else{b6+=`<div style="color:var(--mg);font-style:italic">Dane hierarchii fraz pojawiƒÖ siƒô w KROK 5</div>`}
    h+=s1Sec(6,'Phrase Hierarchy ‚Äî strategia s≈Ç√≥w kluczowych',phKeys.length?phKeys.join(', '):'',b6);

    // ‚îÄ‚îÄ‚îÄ 7Ô∏è‚É£ Depth Analysis ‚îÄ‚îÄ‚îÄ
    let b7='';
    const ds=d.depth_signals||{},dmi=d.depth_missing_items||[];
    const depthItems=[
        ['üî¢','Liczby / dane ilo≈õciowe',ds.numbers_used],['üìÖ','Daty / ramy czasowe',ds.dates_used],
        ['üèõÔ∏è','Instytucje / organizacje',ds.institutions_cited],['üìö','Badania / ≈∫r√≥d≈Ça',ds.research_cited],
        ['‚öñÔ∏è','Przepisy prawne',ds.laws_referenced],['‚ö†Ô∏è','WyjƒÖtki / edge cases',ds.exceptions_noted],
        ['‚öñ','Por√≥wnania',ds.comparisons_made],['üìã','Procesy krok po kroku',ds.step_by_step]
    ];
    b7+=`<div style="font-size:9px;color:var(--mg);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px">Sygna≈Çy g≈Çƒôboko≈õci w konkurencji</div>`;
    depthItems.forEach(([icon,label,val])=>{b7+=`<div class="s1-row"><div class="dot ${val?'on':'off'}"></div>${icon} ${label}</div>`});
    if(dmi.length)b7+=`<div style="margin-top:8px"><div style="font-size:9px;color:var(--yl);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px">Luki g≈Çƒôboko≈õci do wykorzystania</div>${dmi.map(g=>`<span class="tag w">${el(g)}</span>`).join('')}</div>`;
    h+=s1Sec(7,'Analiza g≈Çƒôboko≈õci konkurencji',`${depthItems.filter(x=>x[2]).length}/8 sygna≈Ç√≥w`,b7);

    // ‚îÄ‚îÄ‚îÄ 8Ô∏è‚É£ YMYL Signals ‚îÄ‚îÄ‚îÄ
    let b8='';
    const ym=d.ymyl_hints||{};
    b8+=`<div style="display:flex;flex-wrap:wrap;gap:6px;margin:6px 0">`;
    b8+=`<div class="s1-ymyl ${ym.legal_signals?'active':''}">‚öñÔ∏è Prawo ${ym.legal_signals?'WYKRYTO':'‚Äî'}</div>`;
    b8+=`<div class="s1-ymyl ${ym.medical_signals?'active':''}">üè• Zdrowie ${ym.medical_signals?'WYKRYTO':'‚Äî'}</div>`;
    b8+=`<div class="s1-ymyl ${ym.needs_citations?'active':''}">üìö Cytowania ${ym.needs_citations?'WYMAGANE':'‚Äî'}</div>`;
    b8+=`<div class="s1-ymyl ${ym.needs_disclaimer?'active':''}">‚ö†Ô∏è Disclaimer ${ym.needs_disclaimer?'POTRZEBNY':'‚Äî'}</div>`;
    b8+=`</div>`;
    const anyYmyl=ym.legal_signals||ym.medical_signals||ym.needs_citations||ym.needs_disclaimer;
    if(anyYmyl)b8+=`<div style="margin-top:6px;font-size:10px;color:var(--rd)">‚ö†Ô∏è Szczeg√≥≈Çowa walidacja YMYL w KROK 2</div>`;
    h+=s1Sec(8,'Wstƒôpne sygna≈Çy YMYL',anyYmyl?'‚ö†Ô∏è WYKRYTO':'‚úì BRAK',b8);

    // ‚îÄ‚îÄ‚îÄ 9Ô∏è‚É£ PAA / FAQ Potential ‚îÄ‚îÄ‚îÄ
    let b9='';
    const paa=d.paa_questions||[];
    const paaUn=d.paa_unanswered_count||0;
    if(paa.length){b9+=`<div class="s1-grid" style="grid-template-columns:repeat(2,1fr)"><div class="s1-stat"><div class="v">${paa.length}</div><div class="l">Pyta≈Ñ z SERP</div></div><div class="s1-stat"><div class="v" style="color:var(--rd)">${paaUn}</div><div class="l">Niedopowiedz.</div></div></div>`;b9+=`<div style="margin:8px 0">${paa.map((q,i)=>{const txt=el(q),isUnanswered=pU.some(u=>el(u)===txt);return`<div style="padding:3px 0;font-size:11px;color:var(--lg)"><span style="color:${isUnanswered?'var(--rd)':'var(--orange)'};font-weight:700">${isUnanswered?'‚úó':'‚Ä¢'}</span> ${txt}</div>`}).join('')}</div>`}else{b9+=`<div style="color:var(--mg);font-style:italic">Brak pyta≈Ñ PAA z SERP</div>`}
    h+=s1Sec(9,'Potencja≈Ç FAQ / PAA',`${paa.length} pyta≈Ñ`,b9);

    // ‚îÄ‚îÄ‚îÄ üîü Agent Instructions ‚îÄ‚îÄ‚îÄ
    let b10='';
    const ai=d.agent_instructions||{},sh=d.semantic_hints||{};
    if(ai.gaps)b10+=`<div style="margin:6px 0"><div style="font-size:9px;color:var(--orange);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px;font-weight:700">üìã Priorytety luk</div><div class="s1-instr">${esc(ai.gaps)}</div></div>`;
    if(ai.causal)b10+=`<div style="margin:6px 0"><div style="font-size:9px;color:var(--orange);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px;font-weight:700">üîó Instrukcje kauzalne</div><div class="s1-instr">${esc(ai.causal)}</div></div>`;
    if(ai.semantic&&Object.keys(ai.semantic).length)b10+=`<div style="margin:6px 0"><div style="font-size:9px;color:var(--orange);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px;font-weight:700">üéØ Checkpoints semantyczne</div><div class="s1-instr">${esc(Object.entries(ai.semantic).map(([k,v])=>`${k}: ${v}`).join('\n'))}</div></div>`;
    if(sh.critical_entities&&sh.critical_entities.length)b10+=`<div style="margin:6px 0"><div style="font-size:9px;color:var(--rd);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px">üî¥ Critical entities</div>${sh.critical_entities.map(e=>`<span class="s1-ent must">${e.text||el(e)}${e.importance?` ¬∑ ${e.importance.toFixed(2)}`:''}</span>`).join('')}</div>`;
    if(sh.must_topics&&sh.must_topics.length)b10+=`<div style="margin:6px 0"><div style="font-size:9px;color:var(--orange);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px">üìå Must topics</div>${sh.must_topics.map(t=>`<span class="tag o">${t.topic||el(t)}</span>`).join('')}</div>`;
    if(!ai.gaps&&!ai.causal&&!(sh.critical_entities&&sh.critical_entities.length))b10+=`<div style="color:var(--mg);font-style:italic">Agent instructions wygenerowane wewnƒôtrznie ‚Äî u≈ºywane automatycznie w batch loop</div>`;
    h+=s1Sec(10,'Instrukcje dla modelu',``,b10);

    document.getElementById('s1B').innerHTML=h;
    // Auto-expand first section
    document.getElementById('s1s1').classList.add('open');
}

// ‚ïê‚ïê‚ïê BATCH INSTRUCTIONS ‚ïê‚ïê‚ïê
function rBI(d){
    document.getElementById('biP').style.display='';
    const body=document.getElementById('biB'),cid=`bd${d.batch}`;
    const card=document.createElement('div');card.className='bd';
    let x=`<div style="margin:4px 0"><span class="tag p">${d.batch_type}</span><span class="tag d">${d.word_range} s≈Ç√≥w</span>`;
    if(d.semantic_plan&&d.semantic_plan.profile)x+=`<span class="tag o">${d.semantic_plan.profile}</span>`;
    if(d.batch_length_detail&&d.batch_length_detail.complexity_score)x+=`<span class="tag c">cmplx: ${d.batch_length_detail.complexity_score}</span>`;
    if(d.main_keyword_ratio)x+=`<span class="tag d">MK: ${d.main_keyword_ratio}</span>`;x+=`</div>`;
    x+=`<div class="flags">${fl('instructions',d.has_gpt_instructions,'g')}${fl('prompt',d.has_gpt_prompt,'g')}${fl('memory',d.has_article_memory,'g')}${fl('enhanced',d.has_enhanced,'g')}${fl('style',d.has_style,'g')}${fl('exp_markers',d.experience_markers,'o')}${fl('continuation',d.continuation_context,'o')}${fl('cont_v39',d.has_continuation_v39,'o')}${fl('causal',d.has_causal_context,'p')}${fl('info_gain',d.has_information_gain,'p')}${fl('smart',d.has_smart_instructions,'p')}${fl('hierarchy',d.has_phrase_hierarchy,'o')}${d.has_legal?fl('YMYL legal',1,'r'):''}${d.has_medical?fl('YMYL med',1,'r'):''}</div>`;
    x+=`<div class="sub"><div class="sub-t">MUST (${d.must_keywords.length})</div>${kc(d.must_keywords,'must')}</div>`;
    x+=`<div class="sub"><div class="sub-t">EXTENDED (${d.extended_keywords.length})</div>${kc(d.extended_keywords,'ext')}</div>`;
    if(d.stop_keywords&&d.stop_keywords.length)x+=`<div class="sub"><div class="sub-t">STOP</div>${kc(d.stop_keywords,'stop')}</div>`;
    if(d.caution_keywords&&d.caution_keywords.length)x+=`<div class="sub"><div class="sub-t">CAUTION</div>${kc(d.caution_keywords,'ext')}</div>`;
    if(d.entities_to_define&&d.entities_to_define.length)x+=`<div class="sub"><div class="sub-t">Entities</div>${d.entities_to_define.map(e=>`<span class="tag o">${el(e)}</span>`).join('')}</div>`;
    if(d.relations_to_establish&&d.relations_to_establish.length)x+=`<div class="sub"><div class="sub-t">Relations</div>${d.relations_to_establish.map(r=>`<span class="tag p">${el(r)}</span>`).join('')}</div>`;
    if(d.paa_from_serp&&d.paa_from_serp.length)x+=`<div class="sub"><div class="sub-t">PAA</div>${d.paa_from_serp.map(q=>`<div style="color:var(--lg);font-size:10px">‚Ä¢ ${el(q)}</div>`).join('')}</div>`;
    if(d.coverage&&(d.coverage.basic!==undefined||d.coverage.overall!==undefined)){
        // FIX: Extract numeric value from coverage (may be object {percent:X} or number)
        const cv=v=>{if(typeof v==='number')return v.toFixed(1);if(v&&typeof v==='object')return(v.percent||v.pct||v.value||0).toFixed(1);return'?'};
        const cn=v=>{const n=parseFloat(cv(v));return isNaN(n)?0:n};
        x+=`<div class="sub"><div class="sub-t">Coverage</div>`;
        if(d.coverage.basic!==undefined)x+=`<span class="tag ${cn(d.coverage.basic)>50?'g':'w'}">Basic: ${cv(d.coverage.basic)}%</span>`;
        if(d.coverage.extended!==undefined)x+=`<span class="tag ${cn(d.coverage.extended)>50?'g':'w'}">Ext: ${cv(d.coverage.extended)}%</span>`;
        if(d.coverage.overall!==undefined)x+=`<span class="tag ${cn(d.coverage.overall)>70?'g':'w'}">All: ${cv(d.coverage.overall)}%</span>`;
        x+=`</div>`}
    if(d.article_memory_summary){const am=d.article_memory_summary;x+=`<div class="sub"><div class="sub-t">Article Memory</div>${am.word_count?`<span class="tag d">${am.word_count} s≈Ç√≥w</span>`:''}${am.h2_completed&&am.h2_completed.length?am.h2_completed.map(h=>`<span class="tag g">${esc(h)}</span>`).join(''):''}${am.preview?`<div class="pre">${esc(am.preview)}</div>`:''}</div>`}
    if(d.style_summary){const s=d.style_summary;x+=`<div class="sub"><div class="sub-t">Style</div>${s.tone?`<span class="tag o">${esc(s.tone)}</span>`:''}${s.overused_words&&s.overused_words.length?s.overused_words.map(w=>`<span class="tag r">${esc(w)}</span>`).join(''):''}</div>`}
    if(d.continuation_preview){const cp=d.continuation_preview;x+=`<div class="sub"><div class="sub-t">Kontynuacja</div>${cp.last_topic?`<span class="tag d">${esc(cp.last_topic)}</span>`:''}${cp.transition_hint?`<span class="tag o">${esc(cp.transition_hint)}</span>`:''}</div>`}
    if(d.legal_context_preview)x+=`<div class="sub"><div class="sub-t">‚öñÔ∏è Legal</div><span class="tag r">Active</span>${d.legal_context_preview.instruction_preview?`<div class="pre">${esc(d.legal_context_preview.instruction_preview)}</div>`:''}</div>`;
    if(d.medical_context_preview)x+=`<div class="sub"><div class="sub-t">üè• Medical</div><span class="tag r">Active</span>${d.medical_context_preview.instruction_preview?`<div class="pre">${esc(d.medical_context_preview.instruction_preview)}</div>`:''}</div>`;
    if(d.phrase_hierarchy_data)x+=`<div class="sub"><div class="sub-t">Hierarchy</div>${d.phrase_hierarchy_data.strategy?`<span class="tag p">${esc(d.phrase_hierarchy_data.strategy)}</span>`:''}${(d.phrase_hierarchy_data.roots_covered||[]).map(r=>`<span class="tag c">${ss(r)}</span>`).join('')}</div>`;
    if(d.intro_guidance)x+=`<div class="sub"><div class="sub-t">Intro</div><div class="pre">${esc(d.intro_guidance.substring(0,250))}</div></div>`;
    if(d.causal_context_preview)x+=`<div class="sub"><div class="sub-t">Causal</div><div class="pre">${esc(d.causal_context_preview)}</div></div>`;
    if(d.information_gain_preview)x+=`<div class="sub"><div class="sub-t">Info Gain</div><div class="pre">${esc(d.information_gain_preview)}</div></div>`;
    if(d.smart_instructions_preview)x+=`<div class="sub"><div class="sub-t">Smart Instr</div><div class="pre">${esc(d.smart_instructions_preview)}</div></div>`;
    if(d.gpt_instructions_preview)x+=`<div class="sub"><div class="sub-t">GPT Instr v39</div><div class="pre">${esc(d.gpt_instructions_preview)}</div></div>`;
    if(d.h2_remaining&&d.h2_remaining.length>1)x+=`<div class="sub"><div class="sub-t">H2 remaining</div>${d.h2_remaining.slice(1).map(h=>`<span class="tag d">${esc(h)}</span>`).join('')}</div>`;
    card.innerHTML=`<div class="bd-h" onclick="tBd('${cid}')"><span><strong style="color:var(--orange)">B${d.batch}</strong>/${d.total} ¬∑ <span class="tag p" style="margin:0">${esc(d.batch_type)}</span> ¬∑ <span style="color:var(--lg)">${esc(d.h2)}</span></span><span style="color:var(--mg)">‚ñ∏</span></div><div class="bd-b" id="${cid}">${x}</div>`;
    body.appendChild(card);
}

// ‚ïê‚ïê‚ïê S1 COMPLIANCE ‚ïê‚ïê‚ïê
function rCP(d){
    document.getElementById('cpP').style.display='';
    const body=document.getElementById('cpB'),s=d.summary||{};
    let h=`<div class="cg">
        <div class="cs"><div class="v" style="color:${fc(s.entities||'0/0')}">${s.entities||'‚Äî'}</div><div class="lb">Encje</div></div>
        <div class="cs"><div class="v" style="color:${fc(s.entities_must||'0/0')}">${s.entities_must||'‚Äî'}</div><div class="lb">Must</div></div>
        <div class="cs"><div class="v" style="color:${fc(s.causal_triplets||'0/0')}">${s.causal_triplets||'‚Äî'}</div><div class="lb">Causal</div></div>
        <div class="cs"><div class="v" style="color:${fc(s.content_gaps||'0/0')}">${s.content_gaps||'‚Äî'}</div><div class="lb">Gaps</div></div>
        <div class="cs"><div class="v" style="color:${fc(s.ngrams||'0/0')}">${s.ngrams||'‚Äî'}</div><div class="lb">N-gram</div></div>
        <div class="cs"><div class="v" style="color:${fc(s.paa||'0/0')}">${s.paa||'‚Äî'}</div><div class="lb">PAA</div></div>
        <div class="cs"><div class="v" style="color:${fc(s.semantic_keyphrases||'0/0')}">${s.semantic_keyphrases||'‚Äî'}</div><div class="lb">Sem KP</div></div>
        <div class="cs"><div class="v" style="color:var(--orange)">${s.editorial_score||'‚Äî'}</div><div class="lb">Editorial</div></div>
    </div>`;
    if(d.entities&&d.entities.length)h+=`<div class="sec"><div class="sec-t">Encje</div>${d.entities.map(e=>`<div class="cr ${e.found?'ok':'no'}"><span class="i">${e.found?'‚úì':'‚úó'}</span><span class="l">${e.entity}${e.must?' <span class="tag r" style="font-size:8px;padding:1px 6px">MUST</span>':''}</span></div>`).join('')}</div>`;
    if(d.causal_triplets&&d.causal_triplets.length)h+=`<div class="sec"><div class="sec-t">Causal Triplets</div>${d.causal_triplets.map(t=>{const st=t.fulfilled?'ok':(t.cause_found||t.effect_found?'half':'no');return`<div class="cr ${st}"><span class="i">${t.fulfilled?'‚úì':(t.cause_found||t.effect_found?'~':'‚úó')}</span><span class="l"><span style="color:${t.cause_found?G:R}">${t.cause}</span> ‚Üí <span style="color:${t.effect_found?G:R}">${t.effect}</span></span></div>`}).join('')}</div>`;
    if(d.ngrams&&d.ngrams.length)h+=`<div class="sec"><div class="sec-t">N-gramy</div>${d.ngrams.map(n=>`<div class="cr ${n.found?'ok':'no'}"><span class="i">${n.found?'‚úì':'‚úó'}</span><span class="l">${n.ngram}</span>${n.weight?`<span class="p">${n.weight}</span>`:''}</div>`).join('')}</div>`;
    if(d.semantic_keyphrases&&d.semantic_keyphrases.length)h+=`<div class="sec"><div class="sec-t">Semantic KP</div>${d.semantic_keyphrases.map(k=>`<div class="cr ${k.found?'ok':'no'}"><span class="i">${k.found?'‚úì':'‚úó'}</span><span class="l">${k.phrase}</span></div>`).join('')}</div>`;
    if(d.paa_questions&&d.paa_questions.length)h+=`<div class="sec"><div class="sec-t">PAA</div>${d.paa_questions.map(p=>`<div class="cr ${p.addressed?'ok':'no'}"><span class="i">${p.addressed?'‚úì':'‚úó'}</span><span class="l">${p.question}</span><span class="p">${p.coverage_pct}%</span></div>`).join('')}</div>`;
    if(d.content_gaps_h2&&d.content_gaps_h2.length)h+=`<div class="sec"><div class="sec-t">H2 Gaps</div>${d.content_gaps_h2.map(g=>`<div class="cr ${g.covered?'ok':(g.coverage_pct>25?'half':'no')}"><span class="i">${g.covered?'‚úì':(g.coverage_pct>25?'~':'‚úó')}</span><span class="l">${g.h2}</span><span class="p">${g.coverage_pct}%</span></div>`).join('')}</div>`;
    if(d.content_gaps_paa&&d.content_gaps_paa.length)h+=`<div class="sec"><div class="sec-t">PAA Gaps</div>${d.content_gaps_paa.map(p=>`<div class="cr ${p.answered?'ok':'no'}"><span class="i">${p.answered?'‚úì':'‚úó'}</span><span class="l">${p.question}</span><span class="p">${p.coverage_pct}%</span></div>`).join('')}</div>`;
    body.innerHTML=h;
    if(!body.classList.contains('open'))tPnl('cpP');
}

// ‚ïê‚ïê‚ïê WORKFLOW ‚ïê‚ïê‚ïê
function stopWF(){if(es){es.close();es=null}log('‚õî Zatrzymano');document.getElementById('btnStart').disabled=false;document.getElementById('btnStart').textContent='Uruchom workflow ‚Üí';document.getElementById('btnStop').style.display='none'}
function pt(t){return t.split('\n').map(l=>l.trim()).filter(l=>l.length>0)}

async function startWorkflow(){
    const kw=document.getElementById('mainKeyword').value.trim();
    if(!kw){alert('Wpisz keyword!');return}
    const h2=(document.getElementById('h2Structure').value.trim()||'').split('\n').map(l=>l.trim()).filter(l=>l);
    const bt=pt(document.getElementById('basicTerms').value.trim());
    const et=pt(document.getElementById('extendedTerms').value.trim());

    document.getElementById('btnStart').disabled=true;document.getElementById('btnStart').textContent='Workflow w toku‚Ä¶';
    document.getElementById('btnStop').style.display='';
    document.getElementById('wel').style.display='none';document.getElementById('prog').style.display='';

    for(let i=1;i<=10;i++)uStep(i,'pending','‚Äî');
    ['logC','bRes','biB','s1B','cpB'].forEach(id=>document.getElementById(id).innerHTML='');
    ['bpC','edC','frC','h2C','s1P','biP','cpP','doneB','expB','artP'].forEach(id=>document.getElementById(id).style.display='none');
    log(`Start: "${kw}" [${mode}]`);

    try{
        const resp=await fetch('/api/start',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({main_keyword:kw,mode:mode,h2_structure:h2,basic_terms:bt,extended_terms:et})});
        const data=await resp.json();
        if(!resp.ok||data.error){log(`‚ùå ${data.error||'Server error '+resp.status}`);document.getElementById('btnStart').disabled=false;document.getElementById('btnStart').textContent='Uruchom workflow ‚Üí';if(resp.status===429)log('‚è≥ Poczekaj na zako≈Ñczenie bie≈ºƒÖcego workflow');return}
        jid=data.job_id;log(`Job: ${jid}`);

        const par=new URLSearchParams();par.set('basic_terms',JSON.stringify(bt));par.set('extended_terms',JSON.stringify(et));
        if(es)es.close();es=new EventSource(`/api/stream/${jid}?${par.toString()}`);

        es.addEventListener('step',e=>{const d=JSON.parse(e.data);uStep(d.step,d.status,d.detail||'')});
        es.addEventListener('log',e=>{log(JSON.parse(e.data).msg)});
        es.addEventListener('project',e=>{const d=JSON.parse(e.data);tb=d.total_batches;log(`Project: ${d.project_id}`);const r=document.getElementById('bRes');r.innerHTML='';for(let i=1;i<=tb;i++)r.innerHTML+=`<div class="bchip pend" id="bc${i}">B${i}</div>`});
        es.addEventListener('h2_plan',e=>{const d=JSON.parse(e.data);document.getElementById('h2C').style.display='';document.getElementById('h2L').innerHTML=d.h2_list.map((h,i)=>`<div style="padding:4px 0;border-bottom:1px solid var(--w5);font-size:13px"><span style="color:var(--orange);font-weight:700">${i+1}.</span> ${esc(h)}</div>`).join('')});
        es.addEventListener('s1_data',e=>{rS1(JSON.parse(e.data));const p=document.getElementById('s1P'),b=p.querySelector('.pnl-b'),h=p.querySelector('.pnl-h');if(!b.classList.contains('open')){b.classList.add('open');h.classList.add('open')}});
        es.addEventListener('batch_instructions',e=>{rBI(JSON.parse(e.data))});
        es.addEventListener('batch_start',e=>{const d=JSON.parse(e.data);document.getElementById('bpC').style.display='';document.getElementById('bCt').textContent=`${d.batch}/${d.total}`;document.getElementById('bFill').style.width=((d.batch-1)/d.total*100)+'%'});
        es.addEventListener('batch_result',e=>{const d=JSON.parse(e.data);const c=document.getElementById(`bc${d.batch}`);if(c){c.className=`bchip ${d.accepted?'ok':'bad'}`;c.textContent=`B${d.batch} ${d.quality_score||'?'}`;c.title=`${d.quality_grade||'?'} | D:${d.depth_score||'?'}`}document.getElementById('bFill').style.width=(d.batch/tb*100)+'%';document.getElementById('bCt').textContent=`${d.batch}/${tb}`});
        es.addEventListener('editorial',e=>{const d=JSON.parse(e.data);document.getElementById('edC').style.display='';document.getElementById('edSc').innerHTML=`${d.score}<span>/10</span>`;document.getElementById('edCh').textContent=`${d.changes_applied}/${d.changes_applied+d.changes_failed}`;document.getElementById('edW').textContent=`${d.word_count_before||'?'}‚Üí${d.word_count_after||'?'}`;document.getElementById('edR').textContent=d.rollback?'‚ö†Ô∏è TAK':'‚úì NIE'});
        es.addEventListener('final_review',e=>{const d=JSON.parse(e.data);document.getElementById('frC').style.display='';document.getElementById('frS').textContent=`${d.score}/100`;document.getElementById('frSt').textContent=d.status;document.getElementById('frSt').style.color=d.status==='PASS'?G:d.status==='WARN'?W:R;document.getElementById('frM').textContent=d.missing_keywords_count||0;document.getElementById('frI').textContent=d.issues_count||0;let dt='';if(d.missing_keywords&&d.missing_keywords.length)dt+=`<div>BrakujƒÖce: ${esc(d.missing_keywords.map(k=>typeof k==='string'?k:k.keyword||JSON.stringify(k)).join(', '))}</div>`;if(d.issues&&d.issues.length)dt+=`<div>Issues: ${esc(d.issues.map(i=>typeof i==='string'?i:i.message||JSON.stringify(i)).join('; '))}</div>`;document.getElementById('frD').innerHTML=dt});
        es.addEventListener('s1_compliance',e=>{rCP(JSON.parse(e.data))});
        es.addEventListener('article',e=>{const d=JSON.parse(e.data);const pv=document.getElementById('artP');let html=(d.text||'').replace(/^h2:\s*(.+)$/gm,'<h2>$1</h2>').replace(/^h3:\s*(.+)$/gm,'<h3>$1</h3>').replace(/\n\n/g,'</p><p>').replace(/^\s*<\/p>/,'');if(!html.startsWith('<'))html='<p>'+html;if(!html.endsWith('>'))html+='</p>';pv.innerHTML=html;pv.style.display=''});
        es.addEventListener('done',e=>{const d=JSON.parse(e.data);document.getElementById('doneB').style.display='';document.getElementById('doneD').textContent=`${d.project_id} ¬∑ ${d.word_count} s≈Ç√≥w`;if(d.exports){document.getElementById('expB').style.display='';if(d.exports.html)document.getElementById('exH').href=`/api/export/${jid}/html`;if(d.exports.docx)document.getElementById('exD').href=`/api/export/${jid}/docx`}document.getElementById('btnStart').disabled=false;document.getElementById('btnStart').textContent='Uruchom workflow ‚Üí';document.getElementById('btnStop').style.display='none';es.close()});
        es.addEventListener('workflow_error',e=>{const d=JSON.parse(e.data);log(`‚ùå ${d.msg}`);if(d.step)uStep(d.step,'error',d.msg);document.getElementById('btnStart').disabled=false;document.getElementById('btnStart').textContent='Uruchom workflow ‚Üí';document.getElementById('btnStop').style.display='none';es.close()});

        let rr=0;
        es.onerror=()=>{rr++;if(rr>2||es.readyState===EventSource.CLOSED){log(`‚ùå SSE lost (${rr}x) ‚Äî workflow continues server-side`);es.close();es=null;document.getElementById('btnStart').disabled=false;document.getElementById('btnStart').textContent='Uruchom workflow ‚Üí';document.getElementById('btnStop').style.display='none'}else{log(`‚ö†Ô∏è Reconnect ${rr}/2`)}};
        es.onopen=()=>{if(rr>0){log('‚úÖ Reconnected');rr=0}};
    }catch(err){log(`‚ùå ${err.message}`);document.getElementById('btnStart').disabled=false;document.getElementById('btnStart').textContent='Uruchom workflow ‚Üí';document.getElementById('btnStop').style.display='none'}
}
</script>
</body>
</html>
